webpackJsonp([1],{0:function(e,t){},KJUr:function(e,t){},NHnr:function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=s("7+uW"),o=s("OvRC"),i=s.n(o),r=s("DmT9"),a=s.n(r),c={name:"App",data:function(){return{pcConfig:{iceServers:[{url:"stun:stun.l.google.com:19302"},{url:"turn:81.70.41.251:3478",username:"user",credential:"123456"}]},offerOptions:{offerToReceiveVideo:1,offerToReceiveAudio:1},biPeersList:[],peerList:i()(null),pc:null,localPc1:null,localPc2:null,pcMsgTo:{},remotePc:null,isStarted:!1,isTeacher:!0,isReady:!1,sendingMsg:"",activeTab:"chatTab",onlineClients:[],webrtc:null,socket:null,messages:[],localVideo:null,remoteVideo1:null,remoteVideo2:null,remoteVideo3:null,localStream:null,remoteStream:null,remoteStreamNum:0,mediaStreamConstraints:{video:!0,audio:!0},form:{username:"",password:""}}},methods:{getStatus:function(e){return!!this.peerList[e.userId]},startAction:function(e){var t=this;navigator.mediaDevices.getUserMedia(this.mediaStreamConstraints).then(function(s){t.gotLocalMediaStream(s,e)}).catch(this.handleLocalMediaStreamError)},gotLocalMediaStream:function(e,t){this.localVideo=this.$refs.localVideo,this.localVideo.srcObject=e,this.localStream=e,window.localStream=e,t&&"function"==typeof t&&t&&t(),this.trace("Received local stream.")},handleRemoteMediaStreamAdded:function(e,t){e.remoteStream=t.stream;var s=this.$refs["remoteVideo"+e.other.userId][0];s.srcObject=t.stream,s.addEventListener("loadedmetadata",function(){s.play()}),console.log("biPeersList",this.biPeersList),this.remoteStream=t.stream,this.trace("Received remote stream from "+e.other.username)},handleLocalMediaStreamError:function(){console.log("本地视频采集出错")},handleRemoteStreamRemoved:function(e,t){this.trace("Remote stream  removed event",e.other.username)},sendPcMessage:function(e){var t={userId:this.socket.id,username:this.form.username},s=this.pcMsgTo;this.socket.emit("pc message",{from:t,to:s,pcMsg:e})},signalingMessageCallback:function(e){var t=this,s=e.from.userId,n=this.peerList[s];if("offer"===(e=e.pcMsg).type)console.log("signalingMessageCallback offer",e),n.setRemoteDescription(new RTCSessionDescription(e)).then(function(){n.createAnswer().then(function(e){return t.createdAnswerSuccess(n,e)}).catch(t.setSessionDescriptionError)}).catch(this.logError);else if("answer"===e.type)console.log("收到了answer"),console.log("pc",n),n.setRemoteDescription(new RTCSessionDescription(e),function(){},this.logError);else if("candidate"===e.type){var o=new RTCIceCandidate({sdpMLineIndex:e.label,candidate:e.candidate});n.addIceCandidate(o).catch(function(e){console.log("addIceCandidate-error",e)})}},createdAnswerSuccess:function(e,t){var s=this;e.setLocalDescription(t).then(function(){s.sendPcMessage(e.localDescription),s.setLocalDescriptionSuccess(t,"answer"),s.trace("local answer psd set.")}).catch(this.setSessionDescriptionError)},createPeerConnection:function(e,t){var s=e?t.to:t.from;if(!this.peerList[s.userId]){var n=new RTCPeerConnection(this.pcConfig);n.from=t.from,n.to=t.to,n.isSelf=e,n.other=e?t.to:t.from,this.peerList[s.userId]=n,this.biPeersList.push(n),this.createConnect(e,n)}},createConnect:function(e,t){var s=this;t.addEventListener("icecandidate",function(e){console.log("icecandidate event:",e),e.candidate?s.sendPcMessage({type:"candidate",label:e.candidate.sdpMLineIndex,id:e.candidate.sdpMid,candidate:e.candidate.candidate}):console.log("End of candidates.")}),this.localStream?t.addStream(this.localStream):this.startAction(this.addStreamToLocalPc(t)),t.addEventListener("addstream",function(e){console.log("addstream"),s.handleRemoteMediaStreamAdded(t,e)}),t.addEventListener("removestream",function(e){return s.handleRemoteStreamRemoved(t,e)}),e&&t.createOffer(this.offerOptions).then(function(e){return s.createdOfferSuccess(t,e)}).catch(this.logError)},addStreamToLocalPc:function(e){var t=this;return function(){e.addStream(t.localStream)}},createdOfferSuccess:function(e,t){var s=this;e.setLocalDescription(t).then(function(){s.sendPcMessage(e.localDescription),s.setLocalDescriptionSuccess(t,"offer"),s.trace("local offer psd set.")}).catch(this.setSessionDescriptionError)},setLocalDescriptionSuccess:function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1]},setSessionDescriptionError:function(e){this.trace("set session Description error",e)},logError:function(e){e&&("string"==typeof e?console.warn(e):console.warn(e.toString(),e))},interact:function(e){var t=this;this.localStream?(this.socket.emit("interact",{from:{username:this.form.username,userId:this.socket.id},to:e}),this.trace(this.form.username+"向"+e.username+"发起了视频互动的请求")):this.startAction(function(){t.socket.emit("interact",{from:{username:t.form.username,userId:t.socket.id},to:e}),t.trace(t.form.username+"向"+e.username+"发起了视频互动的请求")})},forbidTalk:function(){},handleSendMesssage:function(){if(this.sendingMsg){var e={msg:this.sendingMsg,username:this.form.username};this.socket.emit("message",e),this.updateChatMessage(e),this.sendingMsg=""}},tabClick:function(){},updateChatMessage:function(e){this.messages.push(e)},leaveRoom:function(){this.socket.emit("leave")},joinRoom:function(){var e=this;if(this.form.username)if(this.onlineClients.some(function(t){return t.username===e.form.username}))this.$message("用户已经加入");else{var t=this;this.socket=a.a.connect("http://81.70.41.251:9000",{query:{username:this.form.username,room:"hello"}}),this.socket.on("join",function(t){e.updateChatMessage({msg:t.username+"加入了聊天室",type:"sys"})}),this.socket.on("joined",function(){console.log("i joined th room")}),this.socket.on("ready",function(){e.isReady=!0}),this.socket.on("left",function(){e.socket.disconnect(),e.messages=[],e.onlineClients=[]}),this.socket.on("leave",function(t){e.updateChatMessage({msg:t.username+"离开了聊天室",type:"sys"}),e.biPeersList[t.userId]&&(e.biPeersList[t.userId].close(),delete e.biPeersList[t.userId])}),this.socket.on("clients",function(e){console.log("clients",e),t.onlineClients=e}),this.socket.on("pc message",function(t){e.trace("客户端收到了pc的消息",t),e.signalingMessageCallback(t)}),this.socket.on("message",function(t){e.updateChatMessage(t)}),this.socket.on("interact",function(t){e.$confirm(t.from.username+"想和你视频互动，请接受","提示信息",{distinguishCancelAndClose:!0,confirmButtonText:"接受",cancelButtonText:"拒绝"}).then(function(){e.socket.emit("agree interact",t),e.pcMsgTo=t.from,e.createPeerConnection(!1,t)}).catch(function(){e.socket.emit("refuse interact",t)})}),this.socket.on("agree interact",function(t){e.$message({type:"success",message:t.to.username+"接受了视频互动的请求"}),e.pcMsgTo=t.to,e.trace(t.to.username+"接受了视频互动的请求"),e.createPeerConnection(!0,t)}),this.socket.on("refuse interact",function(t){e.$message({type:"warning",message:t.to.username+"拒绝了视频互动的请求"}),e.trace(t.to.username+"拒绝了视频互动的请求")}),this.socket.on("stop interact",function(t){var s=t.from;e.$message({type:"info",message:s.username+"停止了和您互动，连接即将断开",duration:1500}),console.log("this.biPeersList",e.biPeersList),e.peerList[t.from.userId].close(),e.peerList[t.from.userId]=null;var n=e.biPeersList.findIndex(function(e){return e.other.userId===s.userId});n>-1&&(e.biPeersList[n].close(),e.biPeersList.splice(n,1))})}else this.$message("请输入用户名")},stopInteract:function(e,t){this.socket.emit("stop interact",{from:{username:this.form.username,userId:this.socket.id},to:e.other}),this.biPeersList.splice(t,1),this.peerList[e.other.userId].close(),this.peerList[e.other.userId]=null},init:function(){this.localVideo=this.$refs.localVideo},trace:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";e=e.trim();var s=(window.performance.now()/1e3).toFixed(3);console.log(s,e,t)}},beforeDestroy:function(){for(var e in this.biPeersList=[],this.peerList)this.peerList[e].close(),this.peerList[e]=null},mounted:function(){this.init()}},l={render:function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",{attrs:{id:"app"}},[s("div",{staticClass:"info"},[s("el-form",{ref:"form",attrs:{model:e.form,"label-width":"80px"}},[s("el-form-item",{attrs:{label:"用户名",prop:"username"}},[s("el-input",{model:{value:e.form.username,callback:function(t){e.$set(e.form,"username",t)},expression:"form.username"}})],1),e._v(" "),s("el-form-item",{attrs:{label:"密码",prop:"password"}},[s("el-input",{model:{value:e.form.password,callback:function(t){e.$set(e.form,"password",t)},expression:"form.password"}})],1),e._v(" "),s("el-button",{attrs:{type:"primary",size:"small",disabled:e.socket&&e.socket.connected},on:{click:e.joinRoom}},[e._v("加入聊天室\n      ")]),e._v(" "),s("el-button",{attrs:{type:"primary",size:"small",disabled:!(e.socket&&e.socket.connected)},on:{click:e.leaveRoom}},[e._v("离开聊天室\n      ")]),e._v(" "),s("el-button",{attrs:{type:"primary",size:"small",disabled:!(e.socket&&e.socket.connected&&e.isReady)},on:{click:e.startAction}},[e._v("开始采集本地视频\n      ")])],1)],1),e._v(" "),s("div",{staticClass:"scene"},[s("head",[e._v("在线聊天室")]),e._v(" "),s("div",{directives:[{name:"show",rawName:"v-show",value:e.socket&&e.socket.connected,expression:"socket && socket.connected"}],attrs:{id:"chat"}},[s("el-tabs",{on:{"tab-click":e.tabClick},model:{value:e.activeTab,callback:function(t){e.activeTab=t},expression:"activeTab"}},[s("el-tab-pane",{attrs:{label:"聊天",name:"chatTab"}},[s("div",[s("ul",{staticClass:"chat-message"},e._l(e.messages,function(t,n){return s("li",{key:n},["sys"===t.type?s("div",[s("span",{staticClass:"el-icon-bell",staticStyle:{color:"yellow"}}),e._v(" "),s("span",[e._v(e._s(t.msg))])]):s("div",[s("span",[e._v(e._s(t.username))]),e._v(" "),s("span",[e._v(e._s(t.msg))])])])})),e._v(" "),s("el-input",{attrs:{type:"textarea"},nativeOn:{keyup:function(t){return"button"in t||!e._k(t.keyCode,"enter",13,t.key,"Enter")?e.handleSendMesssage(t):null}},model:{value:e.sendingMsg,callback:function(t){e.sendingMsg=t},expression:"sendingMsg"}}),e._v(" "),s("el-button",{attrs:{type:"primary",size:"small"},on:{click:e.handleSendMesssage}},[e._v("发送")])],1)]),e._v(" "),s("el-tab-pane",{attrs:{label:"用户("+e.onlineClients.length+")",name:"userTab"}},[s("ul",{staticClass:"clients-list"},e._l(e.onlineClients,function(t,n){return s("li",{key:n},[s("span",[e._v(e._s(t.username))]),e._v(" "),t.userId!==e.socket.id&&e.isTeacher?s("el-button",{attrs:{type:"text",size:"mini",disabled:e.getStatus(t)},on:{click:function(s){e.interact(t)}}},[e._v("互动\n                ")]):e._e()],1)}))])],1)],1)]),e._v(" "),s("div",{staticClass:"web-rtc"},[s("div",[s("h4",[e._v("本人")]),e._v(" "),s("video",{ref:"localVideo",attrs:{autoplay:"",playsinline:"",controls:"",id:"local-video"}})])]),e._v(" "),s("div",[s("h4",[e._v("列表渲染")]),e._v(" "),s("ul",{staticClass:"others"},e._l(e.biPeersList,function(t,n){return s("li",{key:n},[s("h4",[e._v(e._s(t.other.username)+"\n          "),s("el-button",{staticStyle:{float:"right"},attrs:{type:"primary"},on:{click:function(s){e.stopInteract(t,n)}}},[e._v("结束互动")])],1),e._v(" "),s("video",{ref:"remoteVideo"+t.other.userId,refInFor:!0,attrs:{autoplay:"",playsinline:"",controls:"",id:"remoteVideo"+t.other.userId}})])}))])])},staticRenderFns:[]};var d=s("VU/8")(c,l,!1,function(e){s("KJUr")},null,null).exports,u=s("zL8q"),m=s.n(u);s("tvR6");n.default.use(m.a),n.default.config.productionTip=!1,new n.default({el:"#app",components:{App:d},template:"<App/>"})},tvR6:function(e,t){}},["NHnr"]);
//# sourceMappingURL=app.2bfd42271c3fed3be64f.js.map